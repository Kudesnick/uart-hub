/***************************************************************************************************
 *   Project:     
 *   Author:        Stulov Tikhon (kudesnick@inbox.ru)
 ***************************************************************************************************
 *   Distribution:  
 *
 ***************************************************************************************************
 *   MCU Family:    STM32F
 *   Compiler:      ARMCC
 ***************************************************************************************************
 *   File:          main.c
 *   Description:   
 *
 ***************************************************************************************************
 *   History:       13.04.2019 - file created
 *
 **************************************************************************************************/

/***************************************************************************************************
 *                                      INCLUDED FILES
 **************************************************************************************************/

#include "RTE_Components.h"
#include CMSIS_device_header

#include <stdint.h>

/***************************************************************************************************
 *                                       DEFINITIONS
 **************************************************************************************************/

#define STACK_SIZE 0x20 // определяем стек

/***************************************************************************************************
 *                                      PRIVATE TYPES
 **************************************************************************************************/

typedef void (* pFunction)(void);

/***************************************************************************************************
 *                               PRIVATE FUNCTION PROTOTYPES
 **************************************************************************************************/

//-- Функция перехода на основную прошивку
static void goto_main(void) __attribute__((section("MICROBOOT_CODE"))) __attribute__((used)); 

/***************************************************************************************************
 *                                       PRIVATE DATA
 **************************************************************************************************/

volatile uint8_t stack[STACK_SIZE];

//-- Формируем таблицу векторов прерываний для первичной инициализации
volatile const struct
{
    void * stack_ptr;
    pFunction main_ptr;
} vectors __attribute__((section("MICROBOOT_DATA"))) __attribute__((used)) = 
{
    (void *)stack,
    goto_main
};

/***************************************************************************************************
 *                                       PUBLIC DATA
 **************************************************************************************************/

/***************************************************************************************************
 *                                      EXTERNAL DATA
 **************************************************************************************************/

extern unsigned int Image$$ER_IROM1$$Base;

/***************************************************************************************************
 *                              EXTERNAL FUNCTION PROTOTYPES
 **************************************************************************************************/

/***************************************************************************************************
 *                                    PRIVATE FUNCTIONS
 **************************************************************************************************/

//-- переход на основной загрузчик
static void goto_main(void)
{
    typedef void (* pFunction)(void);    
    __set_MSP(* (__IO uint32_t * ) ((uint32_t)&Image$$ER_IROM1$$Base));    
    uint32_t jumpAddress = * (__IO uint32_t *) ((uint32_t)&Image$$ER_IROM1$$Base + 4);
    pFunction JumpToApplication = (pFunction) jumpAddress;
    JumpToApplication();
}

/***************************************************************************************************
 *                                       END OF FILE
 **************************************************************************************************/
